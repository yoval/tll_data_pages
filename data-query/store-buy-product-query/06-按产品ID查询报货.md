### 基础查询：详单维度查询

以下查询结果为**所有详单**，后续查询建立在`summary_table`的基础之上。

```sql
-- 拼接订单
WITH report_order AS (
    SELECT 
        t1.id AS 订单ID,
        t1.order_num AS 订单编号,
        t1.order_status AS 订单状态,
        t1.order_time AS 订单时间,
        t1.order_type AS 订单类型,
        t1.order_notes AS 订单备注,
        t1.store_code AS 门店编号,
        t1.actual_amount AS 实际金额
    FROM flink_rps_all_new_tll_order_now_day_df t1
    UNION ALL
    SELECT 
        t2.id AS 订单ID,
        t2.order_num AS 订单编号,
        t2.order_status AS 订单状态,
        t2.order_time AS 订单时间,
        t2.order_type AS 订单类型,
        t2.order_notes AS 订单备注,
        t2.store_code AS 门店编号,
        t2.actual_amount AS 实际金额
    FROM dwd_rps_tll_order_di t2      
),

-- 选择唯一订单ID
unique_orders AS (
    SELECT 
        订单ID,
        订单编号,
        订单状态,
        订单时间,
        订单类型,
        订单备注,
        门店编号,
        实际金额,
        ROW_NUMBER() OVER(PARTITION BY 订单ID ORDER BY 订单时间 DESC) AS rn
    FROM report_order
),


report_order_details AS (
    SELECT 
        id AS 详单ID,
        order_id AS 订单ID,
        product_info AS 存货名称,
        product_specification AS 存货规格,
        product_id AS 产品ID,
        sku_code AS 存货编码,
        quantity AS 数量
    FROM 
        dwd_rps_tll_order_details_di
    UNION ALL
    SELECT 
        id AS 详单ID,
        order_id AS 订单ID,
        product_info AS 存货名称,
        product_specification AS 存货规格,
        product_id AS 产品ID,
        sku_code AS 存货编码,
        quantity AS 数量
    FROM 
        flink_rps_all_new_tll_order_details_now_day_df
),

summary_table AS (
    SELECT DISTINCT
        uo.门店编号,
        uo.订单ID,
        rod.详单ID,
        uo.订单状态,
        uo.订单编号,
        uo.订单类型,
        uo.订单备注,
        uo.订单时间,
        uo.实际金额,
        rod.存货名称,
        rod.存货规格,
        rod.产品ID,
        rod.存货编码,
        rod.数量,
        uo.rn
    FROM 
        unique_orders uo
    LEFT JOIN 
        report_order_details rod
    ON 
        uo.订单ID = rod.订单ID
)

SELECT * FROM summary_table
limit 100
```

查询结果:

| 门店编号 | 订单ID             | 详单ID | 订单状态 | 订单编号       | 订单类型 | 订单备注 | 订单时间            | 实际金额 | 存货名称                  | 存货规格     | 产品ID             | 存货编码  | 数量 | rn   |
| -------- | ------------------ | ------ | -------- | -------------- | -------- | -------- | ------------------- | -------- | ------------------------- | ------------ | ------------------ | --------- | ---- | ---- |
| TLL04738 | 491471906114387968 | 186053 | 9        | DH091826342406 | 1        |          | 2024-09-18 12:54:02 | 17116    | 清风茉白双层纸杯-500个/件 | 500个/件     | 483962585369153536 | 050001521 | 2    | 1    |
| TLL04738 | 491471906114387968 | 186048 | 9        | DH091826342406 | 1        |          | 2024-09-18 12:54:02 | 17116    | PLA粗吸管-2000支/件       | 2000支/件    | 483962584903585792 | 060000019 | 2    | 1    |
| TLL04738 | 491471906114387968 | 186042 | 9        | DH091826342406 | 1        |          | 2024-09-18 12:54:02 | 17116    | 冷萃浓缩咖啡液-1L*12盒/箱 | 1L*12盒/箱   | 483962582651244544 | 040001197 | 1    | 1    |
| TLL04945 | 491472191016681472 | 186082 | 9        | DH091861755825 | 1        |          | 2024-09-18 12:55:10 | 19197    | 杯盖(90球形盖)-2000只/件  | 2000只/件    | 483962584765173760 | 060000003 | 1    | 1    |
| TLL04945 | 491472191016681472 | 186065 | 9        | DH091861755825 | 1        |          | 2024-09-18 12:55:10 | 19197    | 白西米-500g*30包/箱       | 500g*30包/箱 | 483962582387003392 | 040000024 | 1    | 1    |
| TLL04945 | 491472191016681472 | 186068 | 9        | DH091861755825 | 1        |          | 2024-09-18 12:55:10 | 19197    | 草莓果肉果酱-1kg*16包/箱  | 1kg*16包/箱  | 483962582449917952 | 020000020 | 1    | 1    |
| TLL04945 | 491472191016681472 | 186058 | 9        | DH091861755825 | 1        |          | 2024-09-18 12:55:10 | 19197    | 原味冰淇淋粉-3kg*8包/件   | 3kg*8包/件   | 483962582147928064 | 010000001 | 2    | 1    |
| TLL04945 | 491472191016681472 | 186085 | 9        | DH091861755825 | 1        |          | 2024-09-18 12:55:10 | 19197    | PLA粗吸管-2000支/件       | 2000支/件    | 483962584903585792 | 060000019 | 2    | 1    |
| TLL04945 | 491472191016681472 | 186086 | 9        | DH091861755825 | 1        |          | 2024-09-18 12:55:10 | 19197    | PLA细吸管-3000支/件       | 3000支/件    | 483962584911974400 | 060000020 | 1    | 1    |
| TLL04945 | 491472191016681472 | 186066 | 9        | DH091861755825 | 1        |          | 2024-09-18 12:55:10 | 19197    | 椰果果酱-2kg*9袋/箱       | 2kg*9袋/箱   | 483962582407974912 | 020000006 | 2    | 1    |

### 汇总查询：查询时段内，产品的报货数量

主要用于新品的报货查询，查询时段内报货数量。查询结果兼容脚本。

对基础查询的`summary_table`进行汇总，**查询的前部分保持不变**。

```sql
SELECT
	* 
FROM
	summary_table 
WHERE
	产品 ID IN ( 483962582525415424, 483962582512832512 ) 
	AND 订单状态 >= 3 
	AND 订单状态 != 5 
	AND rn = 1 
	AND date(订单时间) > '2025-03-11 00:00:00' 
ORDER BY
	订单时间 DESC
```

### 汇总查询：查询产品产品上一次报货时间。

主要用于查询基础物料上次报货时间，查询结果兼容脚本。

对基础查询的`summary_table`进行汇总，**查询的前部分保持不变**。

```sql
SELECT *
FROM (
    SELECT 
        *,
        ROW_NUMBER() OVER (PARTITION BY 门店编号, 产品ID ORDER BY 订单时间 DESC) AS rk
    FROM 
        summary_table
    WHERE 
        产品ID IN (483962582525415424, 483962582512832512, 483962582638661632, 483962582672216064, 483962584903585792, 483962584911974400)
        AND 订单状态 >= 3
        AND 订单状态 != 5
				AND rn =1
) t
WHERE 
    t.rk= 1
ORDER BY 
    订单时间 DESC;
```

查询结果：

| 门店编号 | 订单ID             | 详单ID  | 订单状态 | 订单编号       | 订单类型 | 订单时间            | 实际金额 | 存货名称            | 存货规格   | 产品ID             | 存货编码  | 数量 | 订单备注 | rn   | rk   |
| -------- | ------------------ | ------- | -------- | -------------- | -------- | ------------------- | -------- | ------------------- | ---------- | ------------------ | --------- | ---- | -------- | ---- | ---- |
| TLL07265 | 555306065974542336 | 1734713 | 7        | DH031396268729 | 1        | 2025-03-13 16:28:46 | 12054    | 黄柠檬-15kg/箱      | 15kg/箱    | 483962582525415424 | 040000045 | 2    |          | 1    | 1    |
| TLL07265 | 555306065974542336 | 1734712 | 7        | DH031396268729 | 1        | 2025-03-13 16:28:46 | 12054    | 鲜橙-15kg/箱        | 15kg/箱    | 483962582512832512 | 040000006 | 2    |          | 1    | 1    |
| TLL07265 | 555306065974542336 | 1734715 | 7        | DH031396268729 | 1        | 2025-03-13 16:28:46 | 12054    | 调味糖浆-4kg*6瓶/箱 | 4kg*6瓶/箱 | 483962582672216064 | 040001341 | 10   |          | 1    | 1    |
| TLL03593 | 555303895065706496 | 1734693 | 7        | DH031322198147 | 1        | 2025-03-13 16:20:41 | 12390    | 黄柠檬-15kg/箱      | 15kg/箱    | 483962582525415424 | 040000045 | 3    |          | 1    | 1    |
| TLL03593 | 555303895065706496 | 1734696 | 7        | DH031322198147 | 1        | 2025-03-13 16:20:41 | 12390    | 调味糖浆-6kg*4瓶/箱 | 6kg*4瓶/箱 | 483962582638661632 | 040001022 | 6    |          | 1    | 1    |
| TLL03793 | 555294312825896960 | 1734667 | 7        | DH031364974898 | 1        | 2025-03-13 16:17:39 | 15032    | PLA细吸管-3000支/件 | 3000支/件  | 483962584911974400 | 060000020 | 1    |          | 1    | 1    |
| TLL03793 | 555294312825896960 | 1734659 | 7        | DH031364974898 | 1        | 2025-03-13 16:17:39 | 15032    | 鲜橙-15kg/箱        | 15kg/箱    | 483962582512832512 | 040000006 | 1    |          | 1    | 1    |
| TLL03793 | 555294312825896960 | 1734666 | 7        | DH031364974898 | 1        | 2025-03-13 16:17:39 | 15032    | PLA粗吸管-2000支/件 | 2000支/件  | 483962584903585792 | 060000019 | 2    |          | 1    | 1    |
| TLL03793 | 555294312825896960 | 1734662 | 7        | DH031364974898 | 1        | 2025-03-13 16:17:39 | 15032    | 调味糖浆-6kg*4瓶/箱 | 6kg*4瓶/箱 | 483962582638661632 | 040001022 | 5    |          | 1    | 1    |
| TLL03793 | 555294312825896960 | 1734660 | 7        | DH031364974898 | 1        | 2025-03-13 16:17:39 | 15032    | 黄柠檬-15kg/箱      | 15kg/箱    | 483962582525415424 | 040000045 | 1    |          | 1    | 1    |
